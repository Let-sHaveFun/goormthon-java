plugins {
    id 'java'
    id 'org.springframework.boot' version '3.5.3'
    id 'io.spring.dependency-management' version '1.1.7'
}

group = 'com'
version = '0.0.1-SNAPSHOT'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }

    // ë¡œê¹… ì¶©ëŒ ë°©ì§€
    all {
        exclude group: 'org.slf4j', module: 'slf4j-simple'
    }
}

repositories {
    mavenCentral()
}

dependencies {
    // Spring Boot Starters
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'
    implementation 'org.springframework.boot:spring-boot-starter-webflux'
    implementation 'org.springframework.boot:spring-boot-starter-actuator'  // í—¬ìŠ¤ì²´í¬ìš© ì¶”ê°€
    implementation 'org.springframework.boot:spring-boot-starter-validation'  // ê²€ì¦ìš© ì¶”ê°€

    implementation 'io.projectreactor.netty:reactor-netty'
    implementation 'io.netty:netty-all'

    // ğŸ¤” data-jdbcì™€ data-jpa ë™ì‹œ ì‚¬ìš© - í•„ìš”ì‹œì—ë§Œ ìœ ì§€
    implementation 'org.springframework.boot:spring-boot-starter-data-jdbc'

    // ğŸ¤” Thymeleaf - API ì„œë²„ë¼ë©´ ë¶ˆí•„ìš”í•  ìˆ˜ ìˆìŒ
    implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'

    // API Documentation
    implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.2.0'

    // Database
    runtimeOnly 'com.mysql:mysql-connector-j'
    runtimeOnly 'com.h2database:h2'  // ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©

    // AWS SDK - ğŸš¨ ë²„ì „ ì—…ë°ì´íŠ¸ ê¶Œì¥
    implementation 'com.amazonaws:aws-java-sdk-s3:1.12.565'
    // ë˜ëŠ” AWS SDK v2 ì‚¬ìš© ê¶Œì¥:
    // implementation 'software.amazon.awssdk:s3:2.20.0'

    // JSON Processing (Spring Bootì— ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆì§€ë§Œ ëª…ì‹œì  ì„ ì–¸)
    implementation 'com.fasterxml.jackson.core:jackson-databind'

    // JWT - ğŸš¨ ë²„ì „ ì—…ë°ì´íŠ¸ ê¶Œì¥
    implementation 'io.jsonwebtoken:jjwt-api:0.12.3'  // 0.11.5 â†’ 0.12.3
    runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.12.3'
    runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.12.3'

    // Lombok
    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'
    implementation 'ch.qos.logback:logback-classic'
    implementation 'org.slf4j:slf4j-api'

    // Development Tools
    developmentOnly 'org.springframework.boot:spring-boot-devtools'

    // Jakarta Annotations
    implementation 'jakarta.annotation:jakarta.annotation-api:2.1.1'

    // Environment Variables
    implementation 'io.github.cdimascio:dotenv-java:3.0.0'

    // Test Dependencies
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'org.testcontainers:junit-jupiter'
    testImplementation 'org.testcontainers:mysql'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'

    // í…ŒìŠ¤íŠ¸ìš© H2 (ì¤‘ë³µ ì œê±°)
    testRuntimeOnly 'com.h2database:h2'

    // ì„ë² ë””ë“œ Redis (í…ŒìŠ¤íŠ¸ìš©)
    testImplementation('it.ozimov:embedded-redis:0.7.3') {
        exclude group: 'org.slf4j', module: 'slf4j-simple'
    }

    // í…ŒìŠ¤íŠ¸ìš© Lombok
    testCompileOnly 'org.projectlombok:lombok'
    testAnnotationProcessor 'org.projectlombok:lombok'
}

// âœ… Spring Boot executable JAR ì„¤ì •
tasks.named('bootJar') {
    enabled = true
    archiveFileName = 'app.jar'

    // ë©”ì¸ í´ë˜ìŠ¤ ëª…ì‹œ (í•„ìš”ì‹œ)
    // mainClass = 'com.mycompany.goormthonserver.GoormthonServerApplication'
}

// âœ… ì¼ë°˜ JAR ë¹„í™œì„±í™”
tasks.named('jar') {
    enabled = false
}

// âœ… í…ŒìŠ¤íŠ¸ ì„¤ì •
tasks.named('test') {
    useJUnitPlatform()

    // í…ŒìŠ¤íŠ¸ìš© í”„ë¡œíŒŒì¼ ì„¤ì •
    systemProperty 'spring.profiles.active', 'test'

    // í…ŒìŠ¤íŠ¸ ë©”ëª¨ë¦¬ ì„¤ì •
    maxHeapSize = '512m'

    // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë³´ê³ ì„œ
    testLogging {
        events "passed", "skipped", "failed"
        exceptionFormat "full"
    }
}

// âœ… í”„ë¦¬í‹°ì–´ìš© ì‹¤í–‰ ì„¤ì •
tasks.named('bootRun') {
    if (project.hasProperty('spring.profiles.active')) {
        systemProperty 'spring.profiles.active', project.property('spring.profiles.active')
    }

    jvmArgs = [
            '-Xms128m',
            '-Xmx256m',
            '-XX:+UseG1GC',
            '-XX:MaxGCPauseMillis=200',
            '-XX:+UseStringDeduplication'  // JDK 21ì—ì„œ ë” íš¨ìœ¨ì 
    ]
}

// âœ… Gradle ë˜í¼ ì„¤ì •
wrapper {
    gradleVersion = '8.5'
    distributionType = Wrapper.DistributionType.BIN
}